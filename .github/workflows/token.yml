name: Test OIDC GET Request

on:
  push:
    branches:
      - main

permissions:
  id-token: write   
  contents: read    

jobs:
  oidc-get:
    runs-on: ubuntu-latest
    env:
      CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

    steps:
      - name: ğŸ” Request OIDC token from GitHub
        id: fetch_token
        run: |
          echo "ğŸŒ Requesting OIDC token..."
          raw=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://${CLIENT_ID}")
          echo "ğŸ” Raw token response JSON: $raw"
          token=$(echo "$raw" | jq -r '.value')
          echo "âœ”ï¸ Token length: ${#token}"
          echo "TOKEN=$token" >> $GITHUB_ENV

      - name: ğŸ“¡ Send GET request to prod
        run: |
          echo "ğŸš€ Sending GET to https://sentinel-content-validationapi-prod-bvgsc3hjhyeqangg.canadacentral-01.azurewebsites.net/ "
          response=$(curl -s -H "Authorization: Bearer $TOKEN" "https://sentinel-content-validationapi-prod-bvgsc3hjhyeqangg.canadacentral-01.azurewebsites.net/ ")
          echo "ğŸ” Response JSON:"
          echo "$response" | jq .

      - name: ğŸ“¡ Send GET request too dev 
        run: |
          echo "ğŸš€ Sending GET to dev"
          response=$(curl -s -H "Authorization: Bearer $TOKEN" "https://sentintel-content-dev-fue4ashcg9fnfge9.canadacentral-01.azurewebsites.net/")
          echo "ğŸ” Response JSON:"
          echo "$response" | jq .
        
