# .github/workflows/test-oidc-get.yml
name: Test OIDC GET Request

on:
  push:
    branches:
      - main

permissions:
  id-token: write   # enable OIDC token issuance
  contents: read    # allows checkout (not strictly needed here)

jobs:
  oidc-get:
    runs-on: ubuntu-latest
    env:
      CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      API_URL: https://<your-app-name>.azurewebsites.net/validate  # ğŸ” replace with your GET endpoint

    steps:
      - name: ğŸ” Request OIDC token from GitHub
        id: fetch_token
        run: |
          echo "ğŸŒ Requesting OIDC token..."
          raw=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=api://${CLIENT_ID}")
          echo "ğŸ” Raw token response JSON: $raw"
          token=$(echo "$raw" | jq -r '.value')
          echo "âœ”ï¸ Token length: ${#token}"
          echo "TOKEN=$token" >> $GITHUB_ENV

      - name: ğŸ“¡ Send GET request with Bearer token
        run: |
          echo "ğŸš€ Sending GET to $API_URL"
          response=$(curl -s -H "Authorization: Bearer $TOKEN" "$API_URL")
          echo "ğŸ” Response JSON:"
          echo "$response" | jq .
